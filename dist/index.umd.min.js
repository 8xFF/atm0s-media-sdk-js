/*!
 * atm0s-media-js v0.0.0
 * (c) Luong Ngoc Minh
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("debug"),require("pako"),require("ts-debounce")):"function"==typeof define&&define.amd?define(["exports","debug","pako","ts-debounce"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["[libraryCamelCaseName]"]={},e._debug,e.pako,e.tsDebounce)}(this,(function(e,t,n,r){"use strict";var o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)};function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var s=function(){return s=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},s.apply(this,arguments)};function c(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{a(r.next(e))}catch(e){i(e)}}function c(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}a((r=r.apply(e,t||[])).next())}))}function a(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(c){return function(a){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,c[0]&&(s=0)),s;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,r=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==c[0]&&2!==c[0])){s=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){s.label=c[1];break}if(6===c[0]&&s.label<o[1]){s.label=o[1],o=c;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(c);break}o[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(e,s)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}}function u(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function d(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s}function l(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}function f(e,t){var n=new Headers;n.append("Content-Type","application/json");var r=JSON.stringify(t);return fetch(e,{method:"POST",headers:n,body:r,redirect:"follow"}).then((function(e){return e.text()})).then((function(e){return JSON.parse(e)}))}function h(e){var t=new Headers;return t.append("Content-Type","application/json"),fetch(e,{method:"GET",headers:t,redirect:"follow"}).then((function(e){return e.text()})).then((function(e){return JSON.parse(e)}))}"function"==typeof SuppressedError&&SuppressedError;var p=function(){function e(e){this._url=e,this._log=t("atm0s:media-server")}return Object.defineProperty(e.prototype,"url",{get:function(){return this._url},enumerable:!1,configurable:!0}),e.prototype.selectFromUrls=function(e){return c(this,void 0,void 0,(function(){var t,n,r,o,i,s,c,d,l;return a(this,(function(a){switch(a.label){case 0:if("string"==typeof e)return[2,this._url=e];t={},a.label=1;case 1:a.trys.push([1,8,9,10]),n=u(e),r=n.next(),a.label=2;case 2:if(r.done)return[3,7];o=r.value,t[o]=!0,a.label=3;case 3:return a.trys.push([3,5,,6]),[4,h(o+"/healthcheck?ts="+(new Date).getTime())];case 4:return!0===(i=a.sent()).status&&i.data&&!0===i.data.ready?[2,o]:[3,6];case 5:return s=a.sent(),delete t[o],this._log("selectFromUrls :: error:",t,o,s),[3,6];case 6:return r=n.next(),[3,2];case 7:return[3,10];case 8:return c=a.sent(),d={error:c},[3,10];case 9:try{r&&!r.done&&(l=n.return)&&l.call(n)}finally{if(d)throw d.error}return[7];case 10:throw new Error("No available media server")}}))}))},e.prototype.connect=function(e,t){return c(this,void 0,void 0,(function(){return a(this,(function(n){return this._log("connect :: connect to media server:",this._url),[2,f(e+"/webrtc/connect",t)]}))}))},e.prototype.iceCandidate=function(e,t,n,r){var o,i,s,u;return c(this,void 0,void 0,(function(){var c,d;return a(this,(function(a){switch(a.label){case 0:return this._log("iceCandidate :: ice candidate to media server:",e),c={node_id:t,conn_id:n,candidate:(null===(o=r.candidate)||void 0===o?void 0:o.candidate)||"",sdp_mid:(null===(i=r.candidate)||void 0===i?void 0:i.sdpMid)||"",sdp_mline_index:(null===(s=r.candidate)||void 0===s?void 0:s.sdpMLineIndex)||0,username_fragment:(null===(u=r.candidate)||void 0===u?void 0:u.usernameFragment)||""},[4,f(e+"/webrtc/ice_remote",c)];case 1:return d=a.sent(),this._log("iceCandidate :: ice candidate response:",d),[2]}}))}))},e}();function v(e){return c(this,void 0,void 0,(function(){return a(this,(function(t){return[2,new Promise((function(t){setTimeout(t,e)}))]}))}))}function _(e,t){if(e)return"audio"===t?e.getAudioTracks()[0]:"video"===t?e.getVideoTracks()[0]:void 0}var m,y,g,S,k,w,b=function(){function e(){this.events={}}return e.prototype.emit=function(e){for(var t,n,r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];try{for(var i=u(this.events[e]||[]),s=i.next();!s.done;s=i.next()){s.value.apply(void 0,l([],d(r),!1))}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}},e.prototype.on=function(e,t){var n=this;return(this.events[e]=this.events[e]||[]).push(t),function(){return n.events[e]=n.events[e].filter((function(e){return e!==t}))}},e.prototype.off=function(e,t){this.events[e]=this.events[e].filter((function(e){return e!==t}))},e.prototype.offAllListeners=function(){this.events={}},e.prototype.removeAllListeners=function(){this.offAllListeners()},e.prototype.removeListener=function(e,t){this.off(e,t)},e.prototype.listeners=function(e){return this.events[e]},e.prototype.listenerCount=function(e){return this.events[e].length},e}(),C=function(){};!function(e,t,n){var r,o,i,s,c;void 0===n&&(n=!1);for(var a=[t];;){var d=a[0],l=Object.getPrototypeOf(d);if(!(null==l?void 0:l.prototype))break;a.unshift(l)}try{for(var f=u(a),h=f.next();!h.done;h=f.next()){var p=h.value;try{for(var v=(i=void 0,u(Object.getOwnPropertyNames(p.prototype))),_=v.next();!_.done;_=v.next()){var m=_.value;(n||"constructor"!==m)&&Object.defineProperty(e.prototype,m,null!==(c=Object.getOwnPropertyDescriptor(p.prototype,m))&&void 0!==c?c:Object.create(null))}}catch(e){i={error:e}}finally{try{_&&!_.done&&(s=v.return)&&s.call(v)}finally{if(i)throw i.error}}}}catch(e){r={error:e}}finally{try{h&&!h.done&&(o=f.return)&&o.call(f)}finally{if(r)throw r.error}}}(C,b),function(e){e.AUDIO="audio",e.VIDEO="video"}(g||(g={})),function(e){e.OPUS="OPUS",e.VP8="VP8",e.VP9="VP9",e.H264="H264"}(S||(S={})),function(e){e.None="none",e.Motion="motion",e.Detail="detail"}(k||(k={})),function(e){e.UltraLow="ultra-low",e.Default="default",e.Smooth200="smooth-200",e.Smooth500="smooth-500",e.Smooth800="smooth-800",e.Smooth1000="smooth-1000",e.Smooth2000="smooth-2000"}(w||(w={}));var O=((m={})[w.UltraLow]=[10,10],m[w.Smooth200]=[20,20],m[w.Smooth500]=[25,25],m[w.Smooth800]=[40,40],m[w.Smooth1000]=[50,50],m[w.Smooth2000]=[100,100],m[w.Default]=[void 0,void 0],m);(y={})[w.UltraLow]=0,y[w.Smooth200]=.2,y[w.Smooth500]=.5,y[w.Smooth800]=.8,y[w.Smooth1000]=1,y[w.Smooth2000]=2,y[w.Default]=void 0;var T,D,R=function(e){function t(t){return e.call(this,t)||this}return i(t,e),t.prototype.addTransceiver=function(t,n){var r,o=e.prototype.addTransceiver.call(this,t,n);if((null==n?void 0:n.simulcast)&&o&&o.sender){var i=o.sender.getParameters();i.encodings=(null==n?void 0:n.isScreen)?[{rid:"1",active:!0},{rid:"0",active:!0}]:[s({rid:"2",active:!0},(null==n?void 0:n.maxBitrate)&&{maxBitrate:Math.floor(5*(null==n?void 0:n.maxBitrate)/8)}),s(s({rid:"1",active:!0},(null==n?void 0:n.maxBitrate)&&{maxBitrate:Math.floor(2*(null==n?void 0:n.maxBitrate)/8)}),{scaleResolutionDownBy:2}),s(s({rid:"0",active:!0},(null==n?void 0:n.maxBitrate)&&{maxBitrate:Math.floor(1*(null==n?void 0:n.maxBitrate)/8)}),{scaleResolutionDownBy:2})],o.sender.setParameters(i)}if(null==n?void 0:n.preferredCodecs){var c=null===(r=RTCRtpSender.getCapabilities(n.preferredCodecs.kind))||void 0===r?void 0:r.codecs;if(!c)return o;c.sort((function(e,t){var r,o,i=null===(r=n.preferredCodecs)||void 0===r?void 0:r.codecs.indexOf(e.mimeType.replace("video/","")),s=null===(o=n.preferredCodecs)||void 0===o?void 0:o.codecs.indexOf(t.mimeType.replace("video/",""));return i<0&&(i=1e3),s<0&&(s=1e3),i<s?-1:i>s?1:0})),o.setCodecPreferences(c)}return o},t}(RTCPeerConnection),x=function(){function e(t,n,r){this.stream=t,this.info=n,this.transceiver=r,this.uuid="sender-".concat(n.kind,"-").concat(e.seed++)}return e.prototype.replaceStream=function(e){e!==this.stream&&(this.stream=e,this.transceiver&&this.transceiver.sender.replaceTrack(_(e,this.info.kind)||null))},e.prototype.getTrack=function(){return _(this.stream,this.info.kind)},e.seed=0,e}(),I=function(){function e(t,n){this.stream=t,this.info=n;var r=this.getTrack();this.uuid=(null==r?void 0:r.id)||"receiver-".concat(n.kind,"-").concat(e.seed++)}return e.prototype.getTrack=function(){return _(this.stream,this.info.kind)},e.seed=0,e}();!function(e){e.Message="message",e.State="state"}(T||(T={})),function(e){e.Created="created",e.Connecting="connecting",e.Connected="connected",e.Disconnected="disconnected",e.Failed="failed",e.Closed="closed"}(D||(D={}));var P,A=function(e){function r(n,r){var o,i,c=e.call(this)||this;c._urls=n,c._options=r,c._log=t("atm0s:realtime-socket"),c._pConnState=D.Created,c._dcState=D.Created,c._sendStreams=new Map,c._recvStreams=new Map,c._msg_encoder=new TextEncoder;var a=s({iceServers:(null===(o=c._options)||void 0===o?void 0:o.iceServers)||[]},(null===(i=c._options)||void 0===i?void 0:i.latencyMode)&&c._options.latencyMode in O&&{audioJitterBufferMaxPackets:O[c._options.latencyMode],rtcAudioJitterBufferMaxPackets:O[c._options.latencyMode]});return c._lc=new R(a),c._dc=c._lc.createDataChannel("data",{ordered:!1,maxPacketLifeTime:1e4}),c}return i(r,e),r.prototype.connect=function(e,t){return c(this,void 0,void 0,(function(){var n,r,o,i,s,d,l=this;return a(this,(function(f){switch(f.label){case 0:return this._log("connect :: connecting to %s",this._urls),this._pConnState=D.Connecting,[4,e.selectFromUrls(this._urls)];case 1:return n=f.sent(),this._log("connect :: try connect to media server:",n),this._lc.ontrack=function(e){var t,n;if(0!==e.streams.length){var r=e.streams[0],o=e.track;l._log("connect :: received track:",o,r);try{for(var i=u(l._recvStreams.values()),s=i.next();!s.done;s=i.next()){var c=s.value;c.info.remoteId===(null==r?void 0:r.id)&&0===c.stream.getTracks().length&&c.info.kind===o.kind&&(c.stream=r,c.stream.addTrack(o))}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}}else l._log("connect :: no stream found")},this._lc.onconnectionstatechange=function(){switch(l._log("connection state changed:",l._lc.connectionState),l._lc.connectionState){case"connected":l.setConnState(D.Connected);break;case"disconnected":l.setConnState(D.Disconnected);break;case"failed":throw l.setConnState(D.Failed),new Error("Peer Connection failed");case"closed":l.setConnState(D.Closed)}},this._dc.onmessage=function(e){l.emit(T.Message,e.data)},this._dc.onopen=function(){l.setDcState(D.Connected),l._log("datachannel connect :: opended")},this._dc.onerror=function(e){l.setDcState(D.Failed),l._log("datachannel connect :: error:",e)},this._dc.onclose=function(){l.setDcState(D.Closed),l._log("datachannel connect :: closed")},[4,this._lc.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!1})];case 2:return r=f.sent(),this._log("connect :: created offer:",r),[4,e.connect(n,{room:t.roomId,peer:t.peerId,token:t.token,sdp:r.sdp,senders:Array.from(this._sendStreams.values()).map((function(e){return{uuid:e.uuid,label:e.info.label,kind:e.info.kind,screen:e.info.screen}})),receivers:{audio:Array.from(this._recvStreams.values()).filter((function(e){return e.info.kind===g.AUDIO})).length,video:Array.from(this._recvStreams.values()).filter((function(e){return e.info.kind===g.VIDEO})).length}})];case 3:if(!(o=f.sent()).status)throw this._log("connect :: failed to connect:",o),new Error(o.error);return i=o.data.node_id,s=o.data.conn_id,d=o.data.sdp,this._log("connect :: received answer:",i,s,d),this._lc.onicecandidate=function(t){return c(l,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:return t&&t.candidate?[4,e.iceCandidate(n,i,s,t)]:[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))},this._lc.setLocalDescription(r),this._lc.setRemoteDescription(new RTCSessionDescription({sdp:d,type:"answer"})),[2]}}))}))},r.prototype.setConnState=function(e){this._pConnState=e,this.emit("peer_state",this._pConnState)},r.prototype.setDcState=function(e){this._dcState=e,this.emit("dc_state",this._dcState)},r.prototype.createReceiverTrack=function(e,t){var n;this._log("createReceiverTrack :: kind:",t);var r=new MediaStream;null===(n=this._lc)||void 0===n||n.addTransceiver(t,{direction:"recvonly"});var o=new I(r,{remoteId:e,kind:t});return this._recvStreams.set(o.uuid,o),o},r.prototype.createSenderTrack=function(e){var t;this._log("createSenderTrack :: kind:",e.kind);var n=_(e.stream,e.kind),r=(null==n?void 0:n.label)||"not-supported",o=null===(t=this._lc)||void 0===t?void 0:t.addTransceiver(n,{direction:"sendonly",streams:[e.stream],preferredCodecs:{kind:e.kind,codecs:e.preferredCodecs},simulcast:e.simulcast,maxBitrate:e.maxBitrate,isScreen:e.screen}),i=new x(e.stream||null,{label:r,kind:e.kind,name:e.name,screen:!!e.screen},o);return this._sendStreams.set(i.uuid,i),i},r.prototype.generateOffer=function(){return c(this,void 0,void 0,(function(){var e,t;return a(this,(function(n){switch(n.label){case 0:return[4,this._lc.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})];case 1:return e=n.sent(),t={sdp:e.sdp,senders:Array.from(this._sendStreams.values()).map((function(e){return{uuid:e.uuid,label:e.info.label,kind:e.info.kind,screen:e.info.screen}})),receivers:{audio:Array.from(this._recvStreams.values()).filter((function(e){return e.info.kind===g.AUDIO})).length,video:Array.from(this._recvStreams.values()).filter((function(e){return e.info.kind===g.VIDEO})).length}},[2,{offer:e,meta:t}]}}))}))},r.prototype.updateSdp=function(e,t){this._log("updateSdp :: local offer:",e),this._log("updateSdp :: remote answer sdp:",t),this._lc.setLocalDescription(e),this._lc.setRemoteDescription(new RTCSessionDescription({sdp:t,type:"answer"}))},r.prototype.send=function(e){var t,r,o="string"!=typeof e?e:this._msg_encoder.encode(e);if(e.length<1e3)null===(t=this._dc)||void 0===t||t.send(o);else{var i=n.deflate(o);null===(r=this._dc)||void 0===r||r.send(i)}},r.prototype.close=function(){var e,t;return c(this,void 0,void 0,(function(){return a(this,(function(n){switch(n.label){case 0:return null===(e=this._dc)||void 0===e||e.close(),[4,v(500)];case 1:return n.sent(),null===(t=this._lc)||void 0===t||t.close(),[2]}}))}))},r}(C);!function(e){e.NoSource="no_source",e.Connecting="connecting",e.Live="live",e.Pause="paused",e.KeyOnly="key_only",e.SourceDeactived="source_deactived"}(P||(P={}));var E,M=function(e){function n(n,r){var o=e.call(this)||this;return o._rpc=n,o._track=r,o.hasTrack=!1,o.hasTrackPromises=[],o._state=P.NoSource,o._log=t("atm0s:stream-receiver"),o.kind=o._track.info.kind,o.remoteId=o._track.info.remoteId,o._rpc.on("local_stream_".concat(o.remoteId,"_audio_level"),(function(e,t){o._setState(t.state)})),o._rpc.on("local_stream_".concat(o.remoteId,"_state"),(function(e,t){o.emit("audio_level",t.level)})),o}return i(n,e),n.prototype._setState=function(e){this._state=e,this.emit("state",e)},n.prototype.internalReady=function(){return c(this,void 0,void 0,(function(){var e=this;return a(this,(function(t){return this.hasTrack?[2,!0]:[2,new Promise((function(t){e.hasTrackPromises.push(t)}))]}))}))},n.prototype.switch=function(e,t,n){return void 0===n&&(n=50),c(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:return this._log("switch stream",e,t),[4,this.internalReady()];case 1:return r.sent(),this._track.stream?(this._setState(P.Connecting),[4,this._rpc.request("receiver.switch",{id:this.remoteId,priority:n,remote:{peer:t,stream:e}})]):[3,3];case 2:return!0===r.sent().status?[2,!0]:(this._setState(P.NoSource),[2,!1]);case 3:return[2,!1]}}))}))},n.prototype.limit=function(e,t,n){return c(this,void 0,void 0,(function(){return a(this,(function(r){switch(r.label){case 0:return this._log("limit stream",e,t,n),[4,this.internalReady()];case 1:return r.sent(),this._track.stream?[4,this._rpc.request("receiver.limit",{id:this.remoteId,priority:e,max_spatial:t,max_temporal:n})]:[3,3];case 2:return!0===r.sent().status?[2,!0]:[2,!1];case 3:return[2,!1]}}))}))},n.prototype.stop=function(){return c(this,void 0,void 0,(function(){return a(this,(function(e){switch(e.label){case 0:return this._state===P.NoSource?[2,!0]:[4,this._rpc.request("receiver.disconnect",{id:this.remoteId})];case 1:return!0===e.sent().status?(this._setState(P.NoSource),[2,!0]):[2,!1]}}))}))},n}(C),q=function(){function e(e,t,n,r,o){this.reqId=e,this.method=t,this.params=n,this.resolve=r,this.reject=o,this.createdAt=new Date}return e.prototype.toJson=function(){return{req_id:this.reqId,type:"request",request:this.method,data:this.params}},e}(),U=function(){function e(e){var r=this;this._socket=e,this._reqSeed=0,this._msgDecoder=new TextDecoder,this._log=t("atm0s:rpc"),this._handlers=new Map,this._reqs=new Map,this.connected=!1,this._prereceiveMessage=function(e){if(e instanceof Blob){var t=new FileReader;t.onload=function(){var e=new Uint8Array(t.result),o=n.inflate(e),i=r._msgDecoder.decode(o);r._onReceiveMessage(i)},t.readAsArrayBuffer(e)}else if(e instanceof ArrayBuffer){var o=n.inflate(e),i=r._msgDecoder.decode(o);r._log("decompress",e.byteLength,i,i.length),r._onReceiveMessage(i)}else r._onReceiveMessage(e)},this._onReceiveMessage=function(e){r._log("datachannel on message:",e);var t=JSON.parse(e),n=t.type;if("event"===n){var o=r._handlers.get(t.event);o&&o(t.event,t.data)}else if("request"===n)r._socket.send(JSON.stringify({type:"answer",status:!1,error:"NOT_SUPPORT"}));else if("answer"===n){var i=r._reqs.get(t.req_id);i?!0===t.success?i.resolve({status:!0,data:t.data}):i.resolve({status:!1,error:t.error}):r._log}},this._socket.on("message",this._prereceiveMessage),this._socket.on("dc_state",(function(e){e===D.Connected&&(r.connected=!0)}))}return e.prototype.request=function(e,t){var n=this;return new Promise((function(r,o){var i=new q(n._reqSeed++,e,t,r,o);n._reqs.set(i.reqId,i),n._socket.send(JSON.stringify(i.toJson()))}))},e.prototype.on=function(e,t){this._handlers.set(e,t)},e.prototype.off=function(e){this._handlers.delete(e)},e}();!function(e){e.Created="created",e.Connecting="connecting",e.Connected="connected",e.Deactivated="deactived",e.Closed="closed"}(E||(E={}));var N=function(e){function n(n,r){var o=e.call(this)||this;return o._rpc=n,o._track=r,o._state=E.Created,o._log=t("atm0s:stream-sender"),o.kind=o._track.info.kind,o.name=o._track.info.name,o._rpc.on("remote_stream_".concat(o.name,"_state"),(function(){o._state===E.Connecting&&o._setState(E.Connected)})),o._rpc.on("remote_stream_".concat(o.name,"_audio_level"),(function(e,t){o.emit("audio_level",t.level)})),o}return i(n,e),n.prototype._setState=function(e){this._state=e,this.emit("state",e)},n.prototype.switch=function(e){this._log("switch stream",e),this._track.replaceStream(e),this._rpc.request("sender.toggle",{name:this.name,kind:this.kind,track:this._track.uuid}),e?this._setState(E.Connected):this._setState(E.Deactivated)},n.prototype.stop=function(){return c(this,void 0,void 0,(function(){return a(this,(function(e){return this._state===E.Closed||this._setState(E.Closed),[2]}))}))},n}(C),B=function(){function e(e,n,o){this._cfg=e,this._socket=n,this._connector=o,this._audioSenders=new Map,this._videoSenders=new Map,this._audioReceivers=[],this._videoReceivers=[],this._log=t("atm0s:session"),this.update=r.debounce(this.updateSdp,500,{isImmediate:!1}),this._socket.on("message",(function(e){console.log("message",e)})),this._socket.on("peer_state",(function(e){console.log("state",e)})),this._socket.on("dc_state",(function(e){console.log("dc_state",e)})),this._rpc=new U(this._socket)}return e.prototype.connect=function(){return c(this,void 0,void 0,(function(){var e,t,n,r=this;return a(this,(function(o){for(this._log("start to connect ..."),this._cfg.senders.map((function(e){if(e.stream){var t=r._socket.createSenderTrack(e),n=new N(r._rpc,t);t.info.kind===g.AUDIO&&r._audioSenders.set(e.name,n),t.info.kind===g.VIDEO&&r._videoSenders.set(e.name,n)}})),e=0;e<this._cfg.receivers.audio;e++)t=this._socket.createReceiverTrack("audio_".concat(e),g.AUDIO),n=new M(this._rpc,t),this._audioReceivers.push(n);for(e=0;e<this._cfg.receivers.video;e++)t=this._socket.createReceiverTrack("video_".concat(e),g.VIDEO),n=new M(this._rpc,t),this._videoReceivers.push(n);return[2,this._socket.connect(this._connector,this._cfg)]}))}))},e.prototype.createSender=function(e){return c(this,void 0,void 0,(function(){var t,n;return a(this,(function(r){return t=this._socket.createSenderTrack(e),n=new N(this._rpc,t),e.kind===g.AUDIO&&this._audioSenders.set(e.name,n),e.kind===g.VIDEO&&this._videoSenders.set(e.name,n),this.update(),[2,n]}))}))},e.prototype.createReceiver=function(e){return c(this,void 0,void 0,(function(){var t,n;return a(this,(function(r){return t=this._socket.createReceiverTrack("".concat(e,"_").concat(this._audioReceivers.length),e),n=new M(this._rpc,t),e===g.AUDIO&&this._audioReceivers.push(n),e===g.VIDEO&&this._videoReceivers.push(n),this.update(),[2,n]}))}))},e.prototype.takeReceiver=function(e){return c(this,void 0,void 0,(function(){var t;return a(this,(function(n){if(!(t=e===g.AUDIO?this._audioReceivers.shift():this._videoReceivers.shift()))throw new Error("NO_RECEIVER");return[2,t]}))}))},e.prototype.backReceiver=function(e){return c(this,void 0,void 0,(function(){return a(this,(function(t){return e.kind===g.AUDIO&&this._audioReceivers.push(e),e.kind===g.VIDEO&&this._videoReceivers.push(e),[2]}))}))},e.prototype.getSender=function(e,t){return c(this,void 0,void 0,(function(){var n;return a(this,(function(r){if(!(n=t===g.AUDIO?this._audioSenders.get(e):this._videoSenders.get(e)))throw new Error("NO_SENDER");return[2,n]}))}))},e.prototype.updateSdp=function(){return c(this,void 0,void 0,(function(){var e,t,n,r;return a(this,(function(o){switch(o.label){case 0:return[4,this._socket.generateOffer()];case 1:return e=o.sent(),t=e.offer,n=e.meta,this._log("send updated sdp:",n),[4,this._rpc.request("peer.updateSdp",n)];case 2:if(!(r=o.sent()).status)throw this._log("updateSdp :: Error response from server",r),new Error("SERVER_ERROR");return this._log("updateSdp :: received answer:",r.data),this._socket.updateSdp(t,r.data.sdp),[2]}}))}))},e}();e.createSession=function(e,t){var n=new A(e),r=new p;return new B(t,n,r)}}));
//# sourceMappingURL=index.umd.min.js.map
